---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const chapters = await getCollection('chapters');
  return chapters.map((ch) => ({
    params: { book: ch.data.bookSlug, chapter: ch.slug },
    props: { chapter: ch },
  }));
}

const { chapter } = Astro.props;
const { Content } = await chapter.render();

const allChapters = await getCollection('chapters');
const sameBook = allChapters
  .filter((c) => c.data.bookSlug === chapter.data.bookSlug)
  .sort((a, b) => a.data.chapterNumber - b.data.chapterNumber);
const idx = sameBook.findIndex((c) => c.slug === chapter.slug);
const prev = idx > 0 ? sameBook[idx - 1] : null;
const next = idx >= 0 && idx < sameBook.length - 1 ? sameBook[idx + 1] : null;
---
<Layout title={`${chapter.data.title} — ${chapter.data.book}`} description={`${chapter.data.book} Chapter ${chapter.data.chapterNumber}: ${chapter.data.title}`}>
  <script is:inline define:vars={{ chapterSlug: chapter.slug }}>
    window.BIBLE_NOVEL_CHAPTER_SLUG = chapterSlug;
  </script>
  <article class="reader">
    <header class="reader-header">
      <a href="/" class="back-link">← All books</a>
      <h1 class="reader-book">{chapter.data.book}{chapter.data.bookSubtitle ? ` — ${chapter.data.bookSubtitle}` : ''}</h1>
      <h2 class="reader-title">Chapter {chapter.data.chapterNumber} — {chapter.data.title}</h2>
      <div class="reader-progress" role="status" aria-label="Progress in this book">
        <span class="reader-progress-text">Chapter {idx + 1} of {sameBook.length}</span>
        <div class="reader-progress-bar" aria-hidden="true">
          <div class="reader-progress-fill" style={`width: ${((idx + 1) / sameBook.length) * 100}%`}></div>
        </div>
      </div>
      <div class="reader-actions">
        <button type="button" class="read-aloud-btn" id="read-aloud-btn" aria-label="Read this chapter aloud">Read aloud</button>
      </div>
    </header>

    <div class="reader-body" id="chapter-content">
      <Content />
    </div>

    <nav class="reader-nav" aria-label="Previous and next chapter">
      {prev ? (
        <a href={`/read/${chapter.data.bookSlug}/${prev.slug}`} class="nav-link nav-prev">
          <span class="nav-label">Previous</span>
          <span class="nav-title">Chapter {prev.data.chapterNumber} — {prev.data.title}</span>
        </a>
      ) : <span class="nav-placeholder" />}
      <a href="/" class="nav-link nav-toc">Table of contents</a>
      {next ? (
        <a href={`/read/${chapter.data.bookSlug}/${next.slug}`} class="nav-link nav-next">
          <span class="nav-label">Next</span>
          <span class="nav-title">Chapter {next.data.chapterNumber} — {next.data.title}</span>
        </a>
      ) : <span class="nav-placeholder" />}
    </nav>
  </article>
  <script is:inline>
    (function () {
      var btn = document.getElementById('read-aloud-btn');
      var content = document.getElementById('chapter-content');
      if (!btn || !content) return;
      var synth = window.speechSynthesis;
      var speaking = false;
      function stop() {
        synth.cancel();
        speaking = false;
        btn.textContent = 'Read aloud';
        btn.setAttribute('aria-label', 'Read this chapter aloud');
      }
      btn.addEventListener('click', function () {
        if (speaking) {
          stop();
          return;
        }
        var text = content.innerText || content.textContent || '';
        if (!text.trim()) return;
        var u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9;
        u.onend = function () {
          speaking = false;
          btn.textContent = 'Read aloud';
          btn.setAttribute('aria-label', 'Read this chapter aloud');
        };
        u.onerror = function () {
          speaking = false;
          btn.textContent = 'Read aloud';
        };
        synth.speak(u);
        speaking = true;
        btn.textContent = 'Stop';
        btn.setAttribute('aria-label', 'Stop reading aloud');
      });
    })();
  </script>
</Layout>

<style>
  .reader {
    max-width: var(--measure);
    margin: 0 auto;
    padding: var(--space) 1rem 3rem;
  }

  .reader-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-block;
    font-size: 0.9rem;
    color: var(--color-text-soft);
    text-decoration: none;
    margin-bottom: 0.75rem;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .reader-book {
    font-family: var(--font-serif);
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-soft);
    margin: 0 0 0.25rem;
  }

  .reader-title {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-text);
  }

  .reader-progress {
    margin-top: 0.75rem;
  }

  .reader-progress-text {
    font-size: 0.85rem;
    color: var(--color-text-soft);
  }

  .reader-progress-bar {
    height: 4px;
    margin-top: 0.35rem;
    background: var(--color-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .reader-progress-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: 2px;
    transition: width 0.2s ease;
  }

  .reader-actions {
    margin-top: 0.75rem;
  }

  .read-aloud-btn {
    font-size: 0.9rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-paper);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text);
    cursor: pointer;
    font-family: var(--font-sans);
  }

  .read-aloud-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .reader-body {
    font-family: var(--font-serif);
    font-size: 1.15rem;
    line-height: 1.75;
    color: var(--color-text);
  }

  .reader-body :global(p) {
    margin: 0 0 0.75rem;
  }

  .reader-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .reader-nav {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    align-items: center;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-link {
    color: var(--color-text);
    text-decoration: none;
    font-size: 0.95rem;
  }

  .nav-link:hover {
    color: var(--color-accent);
  }

  .nav-prev {
    text-align: left;
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-soft);
    margin-bottom: 0.2rem;
  }

  .nav-toc {
    text-align: center;
    color: var(--color-text-soft);
  }

  .nav-placeholder {
    display: block;
  }

  @media (max-width: 640px) {
    .reader-nav {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .nav-prev,
    .nav-next {
      text-align: center;
    }
  }
</style>
