---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const chapters = await getCollection('chapters');
  return chapters.map((ch) => ({
    params: { book: ch.data.bookSlug, chapter: ch.slug },
    props: { chapter: ch },
  }));
}

const { chapter } = Astro.props;
const { Content } = await chapter.render();

const allChapters = await getCollection('chapters');
const sameBook = allChapters
  .filter((c) => c.data.bookSlug === chapter.data.bookSlug)
  .sort((a, b) => a.data.chapterNumber - b.data.chapterNumber);
const idx = sameBook.findIndex((c) => c.slug === chapter.slug);
const prev = idx > 0 ? sameBook[idx - 1] : null;
const next = idx >= 0 && idx < sameBook.length - 1 ? sameBook[idx + 1] : null;
---
<Layout title={`${chapter.data.title} — ${chapter.data.book}`} description={`${chapter.data.book} Chapter ${chapter.data.chapterNumber}: ${chapter.data.title}`}>
  <script is:inline define:vars={{ chapterSlug: chapter.slug }}>
    window.BIBLE_NOVEL_CHAPTER_SLUG = chapterSlug;
  </script>
  <article class="reader">
    <header class="reader-header">
      <a href="/" class="back-link">← All books</a>
      <h1 class="reader-book">{chapter.data.book}{chapter.data.bookSubtitle ? ` — ${chapter.data.bookSubtitle}` : ''}</h1>
      <h2 class="reader-title">Chapter {chapter.data.chapterNumber} — {chapter.data.title}</h2>
      <div class="reader-progress" role="status" aria-label="Progress in this book">
        <span class="reader-progress-text">Chapter {idx + 1} of {sameBook.length}</span>
        <div class="reader-progress-bar" aria-hidden="true">
          <div class="reader-progress-fill" style={`width: ${((idx + 1) / sameBook.length) * 100}%`}></div>
        </div>
      </div>
      <div class="reader-actions">
        <button type="button" class="read-aloud-btn" id="read-aloud-btn" aria-label="Read this chapter aloud">Read aloud</button>
        <button type="button" class="read-aloud-stop-btn" id="read-aloud-stop-btn" aria-label="Stop and reset">Stop</button>
        <label for="read-aloud-speed" class="read-aloud-speed-label">Speed</label>
        <select id="read-aloud-speed" class="read-aloud-speed" aria-label="Playback speed">
          <option value="1">1×</option>
          <option value="1.2">1.2×</option>
          <option value="1.5">1.5×</option>
          <option value="1.7">1.7×</option>
          <option value="2">2×</option>
        </select>
        <span class="read-aloud-hint" id="read-aloud-hint" aria-live="polite"></span>
      </div>
    </header>

    <div class="reader-body" id="chapter-content">
      <Content />
    </div>

    <nav class="reader-nav" aria-label="Previous and next chapter">
      {prev ? (
        <a href={`/read/${chapter.data.bookSlug}/${prev.slug}`} class="nav-link nav-prev">
          <span class="nav-label">Previous</span>
          <span class="nav-title">Chapter {prev.data.chapterNumber} — {prev.data.title}</span>
        </a>
      ) : <span class="nav-placeholder" />}
      <a href="/" class="nav-link nav-toc">Table of contents</a>
      {next ? (
        <a href={`/read/${chapter.data.bookSlug}/${next.slug}`} class="nav-link nav-next">
          <span class="nav-label">Next</span>
          <span class="nav-title">Chapter {next.data.chapterNumber} — {next.data.title}</span>
        </a>
      ) : <span class="nav-placeholder" />}
    </nav>
  </article>
  <script is:inline define:vars={{ chapterSlug: chapter.slug }}>
    (function () {
      var btn = document.getElementById('read-aloud-btn');
      var stopBtn = document.getElementById('read-aloud-stop-btn');
      var speedSelect = document.getElementById('read-aloud-speed');
      var hint = document.getElementById('read-aloud-hint');
      var content = document.getElementById('chapter-content');
      if (!btn || !content) return;
      var slug = typeof chapterSlug !== 'undefined' ? chapterSlug : '';
      var synth = window.speechSynthesis;
      var status = 'idle';   // 'idle' | 'playing' | 'paused'
      var mode = null;       // null | 'audio' | 'tts'
      var currentAudio = null;
      var currentBlobUrl = null;

      function getSpeed() {
        if (!speedSelect) return 1;
        var n = parseFloat(speedSelect.value, 10);
        return isNaN(n) || n <= 0 ? 1 : n;
      }

      function applySpeedToCurrentAudio() {
        if (mode === 'audio' && currentAudio) {
          currentAudio.playbackRate = getSpeed();
        }
      }

      function updateUI() {
        if (status === 'idle') {
          btn.textContent = 'Read aloud';
          btn.setAttribute('aria-label', 'Read this chapter aloud');
          if (stopBtn) { stopBtn.style.display = 'none'; }
        } else if (status === 'playing') {
          btn.textContent = 'Pause';
          btn.setAttribute('aria-label', 'Pause narration');
          if (stopBtn) { stopBtn.style.display = 'inline-block'; }
        } else {
          btn.textContent = 'Resume';
          btn.setAttribute('aria-label', 'Resume narration');
          if (stopBtn) { stopBtn.style.display = 'inline-block'; }
        }
        if (hint && status === 'idle') hint.textContent = '';
      }

      function pause() {
        if (status !== 'playing') return;
        if (mode === 'audio' && currentAudio) {
          currentAudio.pause();
        } else if (mode === 'tts') {
          synth.pause();
        }
        status = 'paused';
        updateUI();
      }

      function resume() {
        if (status !== 'paused') return;
        if (mode === 'audio' && currentAudio) {
          currentAudio.play();
        } else if (mode === 'tts') {
          synth.resume();
        }
        status = 'playing';
        updateUI();
      }

      function stop() {
        clearReadAloudHighlight();
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio.oncanplaythrough = null;
          currentAudio.onended = null;
          currentAudio.onerror = null;
          currentAudio = null;
        }
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
          currentBlobUrl = null;
        }
        synth.cancel();
        mode = null;
        status = 'idle';
        updateUI();
      }

      function setPlaying() {
        status = 'playing';
        updateUI();
      }

      function setFinished() {
        clearReadAloudHighlight();
        if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
        currentBlobUrl = null;
        currentAudio = null;
        mode = null;
        status = 'idle';
        updateUI();
      }

      function clearReadAloudHighlight() {
        var paras = content.querySelectorAll('p');
        for (var i = 0; i < paras.length; i++) paras[i].classList.remove('read-aloud-current');
      }

      function playWithBrowserTTS() {
        var paras = content.querySelectorAll('p');
        if (paras.length === 0) {
          var text = content.innerText || content.textContent || '';
          if (!text.trim()) return;
          var u = new SpeechSynthesisUtterance(text);
          u.rate = getSpeed();
          u.onend = setFinished;
          u.onerror = setFinished;
          synth.speak(u);
          mode = 'tts';
          setPlaying();
          return;
        }
        mode = 'tts';
        setPlaying();

        function speakNextParagraph(idx) {
          if (status !== 'playing' && status !== 'paused') return;
          clearReadAloudHighlight();
          if (idx >= paras.length) {
            setFinished();
            return;
          }
          paras[idx].classList.add('read-aloud-current');
          paras[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          var u = new SpeechSynthesisUtterance(paras[idx].innerText || paras[idx].textContent || '');
          u.rate = getSpeed();
          u.onend = function () {
            if (status === 'idle') return;
            speakNextParagraph(idx + 1);
          };
          u.onerror = function () {
            setFinished();
          };
          synth.speak(u);
        }
        speakNextParagraph(0);
      }

      if (stopBtn) stopBtn.style.display = 'none';
      if (speedSelect) {
        speedSelect.addEventListener('change', function () {
          applySpeedToCurrentAudio();
        });
      }

      btn.addEventListener('click', function () {
        if (status === 'playing') {
          pause();
          return;
        }
        if (status === 'paused') {
          resume();
          return;
        }
        var text = (content.innerText || content.textContent || '').trim();
        if (!text) return;

        var audioUrl = slug ? '/audio/' + slug + '.mp3' : '';
        if (audioUrl) {
          var a = new Audio(audioUrl);
          currentAudio = a;
          mode = 'audio';
          a.onended = function () {
            if (currentAudio === a) setFinished();
          };
          a.oncanplaythrough = function () {
            if (currentAudio !== a) return;
            if (hint) hint.textContent = 'Playing narration.';
            a.playbackRate = getSpeed();
            a.play();
            setPlaying();
          };
          a.onerror = function (e) {
            if (currentAudio !== a) return;
            currentAudio = null;
            tryApiThenTTS();
          };
          a.load();
        } else {
          tryApiThenTTS();
        }

        function tryApiThenTTS() {
          fetch('/api/speak', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text }),
          })
            .then(function (r) {
              if (r.ok && r.headers.get('Content-Type') && r.headers.get('Content-Type').indexOf('audio') !== -1) {
                return r.blob();
              }
              return Promise.reject(new Error('Not audio'));
            })
            .then(function (blob) {
              if (status !== 'idle' || currentAudio) return;
              if (hint) hint.textContent = 'Playing narration.';
              currentBlobUrl = URL.createObjectURL(blob);
              var a = new Audio(currentBlobUrl);
              currentAudio = a;
              mode = 'audio';
              a.onended = function () {
                if (currentAudio === a) setFinished();
              };
              a.onerror = function () {
                if (currentAudio === a) stop();
              };
              a.playbackRate = getSpeed();
              a.play();
              setPlaying();
            })
            .catch(function (err) {
              if (hint) hint.textContent = 'Using device voice.';
              playWithBrowserTTS();
            });
        }
      });

      if (stopBtn) stopBtn.addEventListener('click', stop);
    })();
  </script>
</Layout>

<style>
  .reader {
    max-width: var(--measure);
    margin: 0 auto;
    padding: 2rem 1.5rem 3rem;
  }

  .reader-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .back-link {
    display: inline-block;
    font-size: 0.9rem;
    color: var(--color-text-soft);
    text-decoration: none;
    margin-bottom: 0.75rem;
    padding: 0.25rem 0;
    border-radius: var(--radius-sm);
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .reader-book {
    font-family: var(--font-serif);
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-soft);
    margin: 0 0 0.25rem;
  }

  .reader-title {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-text);
  }

  .reader-progress {
    margin-top: 0.75rem;
  }

  .reader-progress-text {
    font-size: 0.85rem;
    color: var(--color-text-soft);
  }

  .reader-progress-bar {
    height: 4px;
    margin-top: 0.35rem;
    background: var(--color-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .reader-progress-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: 2px;
    transition: width 0.2s ease;
  }

  .reader-actions {
    margin-top: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .read-aloud-btn {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    background: var(--color-paper);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text);
    cursor: pointer;
    font-family: var(--font-sans);
    transition: border-color 0.15s ease, color 0.15s ease, background 0.15s ease;
  }

  .read-aloud-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-bg);
  }

  .read-aloud-stop-btn {
    font-size: 0.85rem;
    padding: 0.35rem 0.6rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--color-text-soft);
    cursor: pointer;
    font-family: var(--font-sans);
    transition: color 0.15s ease;
  }

  .read-aloud-stop-btn:hover {
    color: var(--color-text);
  }

  .read-aloud-speed-label {
    font-size: 0.85rem;
    color: var(--color-text-soft);
    margin-left: 0.5rem;
  }

  .read-aloud-speed {
    font-size: 0.9rem;
    padding: 0.35rem 0.5rem;
    background: var(--color-paper);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text);
    font-family: var(--font-sans);
    cursor: pointer;
  }

  .read-aloud-speed:hover,
  .read-aloud-speed:focus {
    border-color: var(--color-accent);
    outline: none;
  }

  .read-aloud-hint {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-soft);
    margin-top: 0.35rem;
  }

  .reader-body {
    font-family: var(--font-serif);
    font-size: 1.15rem;
    line-height: 1.75;
    color: var(--color-text);
  }

  .reader-body :global(p) {
    margin: 0 0 0.75rem;
  }

  .reader-body :global(p.read-aloud-current) {
    background: color-mix(in srgb, var(--color-accent) 12%, transparent);
    border-left: 3px solid var(--color-accent);
    margin-left: -0.25rem;
    padding-left: 0.5rem;
    border-radius: 0 4px 4px 0;
    transition: background 0.2s ease, border-color 0.2s ease;
  }

  .reader-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .reader-nav {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    align-items: center;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-link {
    color: var(--color-text);
    text-decoration: none;
    font-size: 0.95rem;
  }

  .nav-link:hover {
    color: var(--color-accent);
  }

  .nav-prev {
    text-align: left;
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-soft);
    margin-bottom: 0.2rem;
  }

  .nav-toc {
    text-align: center;
    color: var(--color-text-soft);
  }

  .nav-placeholder {
    display: block;
  }

  @media (max-width: 640px) {
    .reader-nav {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .nav-prev,
    .nav-next {
      text-align: center;
    }
  }
</style>
